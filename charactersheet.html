<html>

<head>
    <meta charset="utf-8">
    <title>桌脚不稳小龙人大冒险 建卡</title>
    <style>
        .dragable {
            border: 1px gray solid;
            padding: 2px;
        }
    </style>
</head>

<body>
    <p>此次 Roll 点结果：（基本值可用鼠标拖拽调整分配）</p>
    <table>
        <thead>
            <th>属性</th>
            <th>基本值</th>
            <th>训练（<span id="training_point"></span>）</th>
            <th>分配成长率（<span id="free_growth_rate_points"></span>）</th>
            <th>成长率</th>
        </thead>
        <tbody id="basic_properties">
        </tbody>
    </table>
    <p><button id="next_step" onclick="step_training()">下一步</button></p>
</body>
<script type="text/javascript">
    function roll_dice(count, faces, addjust) {
        var result = 0;
        for (let index = 0; index < count; index++) {
            result += Math.floor(Math.random() * faces) + 1;
        }
        return result + addjust;
    }

    function refresh_growth_rate() {
        datasheet.free_growth_rate_points = 50;
        var result = document.querySelectorAll(".basic_property_item");
        result.forEach(element => {
            item = datasheet.basic_properties.find(item => item.name == element.querySelector(".basic_property").id)
            datasheet.free_growth_rate_points -= item.adjust_growth_rate;
            growth_rate = Math.round(item.basic * 0.3 + item.adjust_growth_rate) + item.training_growth_rate;
            var growth_rate_element = element.querySelector(".growth_rate");
            if (growth_rate > 20) {
                growth_rate_element.style.color = "red";
            } else {
                growth_rate_element.style.color = "";
            }
            growth_rate_element.textContent = growth_rate;
        });
        document.getElementById("training_point").textContent = datasheet.training_point.toString();
        document.getElementById("free_growth_rate_points").textContent = datasheet.free_growth_rate_points.toString();
    }



    function training(ev) {
        datasheet.training_point -= 1;
        property_id = ev.target.parentElement.parentElement.querySelector(".basic_property").id;
        var item = datasheet.basic_properties.find(element => element.name == property_id);
        item.training_growth_rate = function(){
            let roll = roll_dice(1, 100, 0);
            if (roll <= 3){
                return 3;
            } else if (roll <= Math.round(Math.round(item.basic * 0.3 + item.adjust_growth_rate) / 3)) {
                return 2;
            } else if (roll <= Math.round(item.basic * 0.3 + item.adjust_growth_rate)) {
                return 1;
            } else {
                return 0;
            }
        }();
        ev.target.hidden = true;
        ev.target.parentElement.textContent = item.training_growth_rate.toString();

        if (datasheet.training_point == 0) {
            document.querySelectorAll(".basic_property_item").forEach(element => {
                let item = datasheet.basic_properties.find(item => item.name == element.querySelector(".basic_property").id);
                var training_button = element.querySelector(".training_button");
                if (training_button) {
                    training_button.hidden = true;
                    training_button.parentElement.textContent = item.training_growth_rate.toString();
                }
            });
        }
        refresh_growth_rate();
    }

    function on_adjust_growth_rate_change(ev) {
        property_id = ev.target.parentElement.parentElement.querySelector(".basic_property").id;
        datasheet.basic_properties.find(element => element.name == property_id).adjust_growth_rate = parseInt(ev.target.value);
        refresh_growth_rate();
    }

    function ui_create_adjust_growth_rate(item) {
        let template = `
    <tr class="basic_property_item">
        <td>${item.name}</td>
        <td><span class="basic_property dragable" id="${item.name}" draggable="true" ondragstart="dragstart_handler(event)" ondragover="dragover_handler(event)" ondrop="drop_handler(event)">${item.basic}</span></td>
        <td>0</td>
        <td><input class="adjust_growth_rate_point" type="number" value="0" min="0" onchange="on_adjust_growth_rate_change(event)"></td>
        <td><span class="growth_rate">${Math.round(item.basic * 0.3 + item.adjust_growth_rate) + item.training_growth_rate}</span></td>
    </tr>`;
        return template;
    }

    function ui_create_training(item) {
        let template = `
    <tr class="basic_property_item">
        <td>${item.name}</td>
        <td><span class="basic_property" id="${item.name}">${item.basic}</span></td>
        <td><button class="training_button" onclick="training(event)">训练</button></td>
        <td>${item.adjust_growth_rate}</td>
        <td><span class="growth_rate">${Math.round(item.basic * 0.3 + item.adjust_growth_rate) + item.training_growth_rate}</span></td>
    </tr>`;
        return template;
    }

    function step_adjust_growth_rate(datasheet) {
        var template = "";
        datasheet.basic_properties.forEach(element => {
            template += ui_create_adjust_growth_rate(element);
        });
        document.getElementById("basic_properties").innerHTML = template;

        document.getElementById("training_point").textContent = datasheet.training_point;
        document.getElementById("free_growth_rate_points").textContent = datasheet.free_growth_rate_points;
    }

    function step_training() {
        var template = "";
        datasheet.basic_properties.forEach(element => {
            template += ui_create_training(element);
        });
        document.getElementById("basic_properties").innerHTML = template;

        document.getElementById("training_point").textContent = datasheet.training_point;
        document.getElementById("next_step").hidden = true;
    }

    function dragstart_handler(ev) {
        let value = document.getElementById(ev.target.id).innerText;
        ev.dataTransfer.setData("text/id", ev.target.id);
        ev.dataTransfer.setData("text/value", value);
        ev.dataTransfer.dropEffect = "move";
    }

    function dragover_handler(ev) {
        ev.preventDefault();
        ev.dataTransfer.dropEffect = "move";
    }

    function drop_handler(ev) {
        ev.preventDefault();
        var data_id = ev.dataTransfer.getData("text/id");
        var ori_item = datasheet.basic_properties.find(element => element.name == data_id);
        var target_item =  datasheet.basic_properties.find(element => element.name == ev.target.id);

        [ori_item.basic, target_item.basic] = [target_item.basic, ori_item.basic];

        document.getElementById(data_id).innerText =ori_item.basic;
        ev.target.innerText = target_item.basic;
        refresh_growth_rate();
    }

    let datasheet = {
        free_growth_rate_points: 50,
        training_point: 2,
        basic_properties: [
            {
                name: "强壮",
                basic: roll_dice(6, 3, 4),
                adjust_growth_rate: 0,
                training_growth_rate: 0,
            },
            {
                name: "敏捷",
                basic: roll_dice(6, 3, 4),
                adjust_growth_rate: 0,
                training_growth_rate: 0,
            },
            {
                name: "才智",
                basic: roll_dice(6, 3, 4),
                adjust_growth_rate: 0,
                training_growth_rate: 0,
            },
            {
                name: "意志",
                basic: roll_dice(6, 3, 4),
                adjust_growth_rate: 0,
                training_growth_rate: 0,
            },
            {
                name: "体能",
                basic: roll_dice(6, 3, 4),
                adjust_growth_rate: 0,
                training_growth_rate: 0,
            },
            {
                name: "健康",
                basic: roll_dice(6, 3, 4),
                adjust_growth_rate: 0,
                training_growth_rate: 0,
            },
            {
                name: "智力",
                basic: roll_dice(6, 3, 4),
                adjust_growth_rate: 0,
                training_growth_rate: 0,
            },
        ],
    };
    step_adjust_growth_rate(datasheet);
</script>

</html>